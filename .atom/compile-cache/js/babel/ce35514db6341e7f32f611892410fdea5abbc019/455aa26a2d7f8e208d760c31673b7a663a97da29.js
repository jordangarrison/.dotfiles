'use babel';

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _createClass = (function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ('value' in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
    }
  }return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
  };
})();

function _classCallCheck(instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError('Cannot call a class as a function');
  }
}

var RefCountedTokenList = (function () {
  function RefCountedTokenList() {
    _classCallCheck(this, RefCountedTokenList);

    this.clear();
  }

  _createClass(RefCountedTokenList, [{
    key: 'clear',
    value: function clear() {
      this.references = {};
      this.tokens = [];
    }
  }, {
    key: 'getLength',
    value: function getLength() {
      return this.tokens.length;
    }
  }, {
    key: 'getTokens',
    value: function getTokens() {
      return this.tokens;
    }
  }, {
    key: 'getTokenWrappers',
    value: function getTokenWrappers() {
      var _this = this;

      return (function () {
        var result = [];
        for (var key in _this.references) {
          var tokenWrapper = _this.references[key];
          result.push(tokenWrapper);
        }
        return result;
      })();
    }
  }, {
    key: 'getToken',
    value: function getToken(tokenKey) {
      var wrapper = this.getTokenWrapper(tokenKey);
      if (wrapper) {
        return wrapper.token;
      }
    }
  }, {
    key: 'getTokenWrapper',
    value: function getTokenWrapper(tokenKey) {
      tokenKey = this.getTokenKey(tokenKey);
      return this.references[tokenKey];
    }
  }, {
    key: 'refCountForToken',
    value: function refCountForToken(tokenKey) {
      tokenKey = this.getTokenKey(tokenKey);
      if (this.references[tokenKey] && this.references[tokenKey].count) {
        return this.references[tokenKey].count;
      }
      return 0;
    }
  }, {
    key: 'addToken',
    value: function addToken(token, tokenKey) {
      tokenKey = this.getTokenKey(token, tokenKey);
      return this.updateRefCount(tokenKey, token, 1);
    }

    // Returns true when the token was removed
    // Returns false when the token was not present and thus not removed
  }, {
    key: 'removeToken',
    value: function removeToken(token, tokenKey) {
      tokenKey = this.getTokenKey(token, tokenKey);
      if (this.references[tokenKey] != null) {
        token = this.references[tokenKey].token;

        this.updateRefCount(tokenKey, token, -1);
        return true;
      } else {
        return false;
      }
    }

    /*
    Private Methods
    */

  }, {
    key: 'updateRefCount',
    value: function updateRefCount(tokenKey, token, increment) {
      if (increment > 0 && this.references[tokenKey] == null) {
        if (this.references[tokenKey] == null) {
          this.references[tokenKey] = { tokenKey: tokenKey, token: token, count: 0 };
        }
        this.addTokenToList(token);
      }

      if (this.references[tokenKey] != null) {
        this.references[tokenKey].count += increment;
      }

      if (this.references[tokenKey] && this.references[tokenKey].count <= 0) {
        delete this.references[tokenKey];
        return this.removeTokenFromList(token);
      }
    }
  }, {
    key: 'addTokenToList',
    value: function addTokenToList(token) {
      return this.tokens.push(token);
    }
  }, {
    key: 'removeTokenFromList',
    value: function removeTokenFromList(token) {
      var index = this.tokens.indexOf(token);
      if (index > -1) {
        return this.tokens.splice(index, 1);
      }
    }
  }, {
    key: 'getTokenKey',
    value: function getTokenKey(token, tokenKey) {
      // some words are reserved, like 'constructor' :/
      if (tokenKey) {
        return tokenKey + '$$';
      }

      return token + '$$';
    }
  }]);

  return RefCountedTokenList;
})();

exports['default'] = RefCountedTokenList;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9idWlsZGRpci9idWlsZC9CVUlMRC9hdG9tLTI3OTE1NzJjZDIwYjFkOGM4NGExMDBlODMwOGRjY2U1N2QxODUzZDcvb3V0L2FwcC9ub2RlX21vZHVsZXMvYXV0b2NvbXBsZXRlLXBsdXMvbGliL3JlZi1jb3VudGVkLXRva2VuLWxpc3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFBOztBQUVYLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFlBQVksRUFBRTtBQUMzQyxPQUFLLEVBQUUsSUFBSTtDQUNaLENBQUMsQ0FBQzs7QUFFSCxJQUFJLFlBQVksR0FBRyxDQUFDLFlBQVk7QUFBRSxXQUFTLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUU7QUFBRSxTQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUFFLFVBQUksVUFBVSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxBQUFDLFVBQVUsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDLFVBQVUsSUFBSSxLQUFLLENBQUMsQUFBQyxVQUFVLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxBQUFDLElBQUksT0FBTyxJQUFJLFVBQVUsRUFBRSxVQUFVLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxBQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7S0FBRTtHQUFFLEFBQUMsT0FBTyxVQUFVLFdBQVcsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFO0FBQUUsUUFBSSxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQyxBQUFDLElBQUksV0FBVyxFQUFFLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQyxBQUFDLE9BQU8sV0FBVyxDQUFD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LENBQUMsQ0FBQyxDQUFDOztBQUVKLFNBM0ltQixtQkFBbUIsQ0FBQTtDQTRJdkMsQ0FBQSxFQUFHLENBQUM7O0FBRUwsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQTlJRyxtQkFBbUIsQ0FBQTtBQStJeEMsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMiLCJmaWxlIjoiL2J1aWxkZGlyL2J1aWxkL0JVSUxEL2F0b20tMjc5MTU3MmNkMjBiMWQ4Yzg0YTEwMGU4MzA4ZGNjZTU3ZDE4NTNkNy9vdXQvYXBwL25vZGVfbW9kdWxlcy9hdXRvY29tcGxldGUtcGx1cy9saWIvcmVmLWNvdW50ZWQtdG9rZW4tbGlzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlZkNvdW50ZWRUb2tlbkxpc3Qge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5jbGVhcigpXG4gIH1cblxuICBjbGVhciAoKSB7XG4gICAgdGhpcy5yZWZlcmVuY2VzID0ge31cbiAgICB0aGlzLnRva2VucyA9IFtdXG4gIH1cblxuICBnZXRMZW5ndGggKCkgeyByZXR1cm4gdGhpcy50b2tlbnMubGVuZ3RoIH1cblxuICBnZXRUb2tlbnMgKCkgeyByZXR1cm4gdGhpcy50b2tlbnMgfVxuXG4gIGdldFRva2VuV3JhcHBlcnMgKCkge1xuICAgIHJldHVybiAoKCgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdXG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnJlZmVyZW5jZXMpIHtcbiAgICAgICAgY29uc3QgdG9rZW5XcmFwcGVyID0gdGhpcy5yZWZlcmVuY2VzW2tleV1cbiAgICAgICAgcmVzdWx0LnB1c2godG9rZW5XcmFwcGVyKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0pKCkpXG4gIH1cblxuICBnZXRUb2tlbiAodG9rZW5LZXkpIHtcbiAgICBjb25zdCB3cmFwcGVyID0gdGhpcy5nZXRUb2tlbldyYXBwZXIodG9rZW5LZXkpXG4gICAgaWYgKHdyYXBwZXIpIHtcbiAgICAgIHJldHVybiB3cmFwcGVyLnRva2VuXG4gICAgfVxuICB9XG5cbiAgZ2V0VG9rZW5XcmFwcGVyICh0b2tlbktleSkge1xuICAgIHRva2VuS2V5ID0gdGhpcy5nZXRUb2tlbktleSh0b2tlbktleSlcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VzW3Rva2VuS2V5XVxuICB9XG5cbiAgcmVmQ291bnRGb3JUb2tlbiAodG9rZW5LZXkpIHtcbiAgICB0b2tlbktleSA9IHRoaXMuZ2V0VG9rZW5LZXkodG9rZW5LZXkpXG4gICAgaWYgKHRoaXMucmVmZXJlbmNlc1t0b2tlbktleV0gJiYgdGhpcy5yZWZlcmVuY2VzW3Rva2VuS2V5XS5jb3VudCkge1xuICAgICAgcmV0dXJuIHRoaXMucmVmZXJlbmNlc1t0b2tlbktleV0uY291bnRcbiAgICB9XG4gICAgcmV0dXJuIDBcbiAgfVxuXG4gIGFkZFRva2VuICh0b2tlbiwgdG9rZW5LZXkpIHtcbiAgICB0b2tlbktleSA9IHRoaXMuZ2V0VG9rZW5LZXkodG9rZW4sIHRva2VuS2V5KVxuICAgIHJldHVybiB0aGlzLnVwZGF0ZVJlZkNvdW50KHRva2VuS2V5LCB0b2tlbiwgMSlcbiAgfVxuXG4gIC8vIFJldHVybnMgdHJ1ZSB3aGVuIHRoZSB0b2tlbiB3YXMgcmVtb3ZlZFxuICAvLyBSZXR1cm5zIGZhbHNlIHdoZW4gdGhlIHRva2VuIHdhcyBub3QgcHJlc2VudCBhbmQgdGh1cyBub3QgcmVtb3ZlZFxuICByZW1vdmVUb2tlbiAodG9rZW4sIHRva2VuS2V5KSB7XG4gICAgdG9rZW5LZXkgPSB0aGlzLmdldFRva2VuS2V5KHRva2VuLCB0b2tlbktleSlcbiAgICBpZiAodGhpcy5yZWZlcmVuY2VzW3Rva2VuS2V5XSAhPSBudWxsKSB7XG4gICAgICAoeyB0b2tlbiB9ID0gdGhpcy5yZWZlcmVuY2VzW3Rva2VuS2V5XSlcbiAgICAgIHRoaXMudXBkYXRlUmVmQ291bnQodG9rZW5LZXksIHRva2VuLCAtMSlcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gIFByaXZhdGUgTWV0aG9kc1xuICAqL1xuXG4gIHVwZGF0ZVJlZkNvdW50ICh0b2tlbktleSwgdG9rZW4sIGluY3JlbWVudCkge1xuICAgIGlmIChpbmNyZW1lbnQgPiAwICYmICh0aGlzLnJlZmVyZW5jZXNbdG9rZW5LZXldID09IG51bGwpKSB7XG4gICAgICBpZiAodGhpcy5yZWZlcmVuY2VzW3Rva2VuS2V5XSA9PSBudWxsKSB7IHRoaXMucmVmZXJlbmNlc1t0b2tlbktleV0gPSB7dG9rZW5LZXksIHRva2VuLCBjb3VudDogMH0gfVxuICAgICAgdGhpcy5hZGRUb2tlblRvTGlzdCh0b2tlbilcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWZlcmVuY2VzW3Rva2VuS2V5XSAhPSBudWxsKSB7IHRoaXMucmVmZXJlbmNlc1t0b2tlbktleV0uY291bnQgKz0gaW5jcmVtZW50IH1cblxuICAgIGlmICh0aGlzLnJlZmVyZW5jZXNbdG9rZW5LZXldICYmIHRoaXMucmVmZXJlbmNlc1t0b2tlbktleV0uY291bnQgPD0gMCkge1xuICAgICAgZGVsZXRlIHRoaXMucmVmZXJlbmNlc1t0b2tlbktleV1cbiAgICAgIHJldHVybiB0aGlzLnJlbW92ZVRva2VuRnJvbUxpc3QodG9rZW4pXG4gICAgfVxuICB9XG5cbiAgYWRkVG9rZW5Ub0xpc3QgKHRva2VuKSB7XG4gICAgcmV0dXJuIHRoaXMudG9rZW5zLnB1c2godG9rZW4pXG4gIH1cblxuICByZW1vdmVUb2tlbkZyb21MaXN0ICh0b2tlbikge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy50b2tlbnMuaW5kZXhPZih0b2tlbilcbiAgICBpZiAoaW5kZXggPiAtMSkgeyByZXR1cm4gdGhpcy50b2tlbnMuc3BsaWNlKGluZGV4LCAxKSB9XG4gIH1cblxuICBnZXRUb2tlbktleSAodG9rZW4sIHRva2VuS2V5KSB7XG4gICAgLy8gc29tZSB3b3JkcyBhcmUgcmVzZXJ2ZWQsIGxpa2UgJ2NvbnN0cnVjdG9yJyA6L1xuICAgIGlmICh0b2tlbktleSkge1xuICAgICAgcmV0dXJuIHRva2VuS2V5ICsgJyQkJ1xuICAgIH1cblxuICAgIHJldHVybiB0b2tlbiArICckJCdcbiAgfVxufVxuIl19