'use babel';
/* global atom, expect, describe, beforeEach, it, waitsForPromise, waitsFor, runs, advanceClock, jasmine */

var COMPLETION_DELAY = 100;

describe('autocomplete-paths', function () {
  var _ref = [];
  var editor = _ref[0];
  var provider = _ref[1];

  var getSuggestions = function getSuggestions() {
    var cursor = editor.getLastCursor();
    var start = cursor.getBeginningOfCurrentWordBufferPosition();
    var end = cursor.getBufferPosition();
    var prefix = editor.getTextInRange([start, end]);
    var request = {
      editor: editor,
      bufferPosition: end,
      scopeDescriptor: cursor.getScopeDescriptor(),
      prefix: prefix
    };
    return provider.getSuggestions(request);
  };

  beforeEach(function () {
    atom.config.set('autocomplete-plus.enableAutoActivation', true);
    atom.config.set('autocomplete-plus.autoActivationDelay', COMPLETION_DELAY);

    var workspaceElement = atom.views.getView(atom.workspace);
    jasmine.attachToDOM(workspaceElement);

    waitsForPromise(function () {
      return Promise.all([atom.workspace.open('sample.js').then(function (e) {
        editor = e;
      }), atom.packages.activatePackage('language-javascript'), atom.packages.activatePackage('autocomplete-paths'), atom.packages.activatePackage('autocomplete-plus'), atom.packages.activatePackage('status-bar')]);
    });
    runs(function () {
      provider = atom.packages.getActivePackage('autocomplete-paths').mainModule.getProvider();
    });
    waitsFor(function () {
      return provider.isReady();
    });
  });

  it('triggers when text before cursor matches one of the scopes', function () {
    runs(function () {
      editor.setText('require(\'t');
      editor.setCursorBufferPosition([0, Infinity]);
    });
    waitsForPromise(function () {
      return getSuggestions().then(function (suggestions) {
        expect(suggestions).toHaveLength(2);
      });
    });
  });

  it('only displays files relevant to the matching scope', function () {
    waitsForPromise(function () {
      return atom.packages.activatePackage('language-javascript');
    });
    runs(function () {
      editor.setText('require(\'t');
      editor.setCursorBufferPosition([0, Infinity]);
    });
    waitsForPromise(function () {
      return getSuggestions().then(function (suggestions) {
        expect(suggestions).toHaveLength(2);
        expect(suggestions[0].displayText).toBe('somedir/testfile.js');
        expect(suggestions[1].displayText).toBe('somedir/testdir/nested-test-file.js');
      });
    });
  });

  it('removes the extension when accepting a JS import suggestion', function () {
    var editorView = undefined;
    waitsForPromise(function () {
      return atom.packages.activatePackage('language-javascript');
    });
    runs(function () {
      editorView = atom.views.getView(editor);
      editor.setText('require(\'');
      editor.moveToBottom();
      editor.insertText('t');
      editor.insertText('e');
      editor.insertText('s');

      advanceClock(COMPLETION_DELAY);
    });
    waitsFor('autocomplete view to appear', 1000, function () {
      return editorView.querySelector('.autocomplete-plus');
    });
    runs(function () {
      atom.commands.dispatch(editorView, 'autocomplete-plus:confirm');

      expect(editor.getText()).toEqual('require(\'./somedir/testfile');
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2pnYXJyaXNvbi8uYXRvbS9wYWNrYWdlcy9hdXRvY29tcGxldGUtcGF0aHMvc3BlYy9hdXRvY29tcGxldGUtcGF0aHMtc3BlYy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUE7OztBQUdYLElBQU0sZ0JBQWdCLEdBQUcsR0FBRyxDQUFBOztBQUU1QixRQUFRLENBQUMsb0JBQW9CLEVBQUUsWUFBTTthQUNSLEVBQUU7TUFBdkIsTUFBTTtNQUFFLFFBQVE7O0FBQ3RCLE1BQU0sY0FBYyxHQUFHLFNBQWpCLGNBQWMsR0FBUztBQUMzQixRQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUE7QUFDckMsUUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLHVDQUF1QyxFQUFFLENBQUE7QUFDOUQsUUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixFQUFFLENBQUE7QUFDdEMsUUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ2xELFFBQU0sT0FBTyxHQUFHO0FBQ2QsWUFBTSxFQUFOLE1BQU07QUFDTixvQkFBYyxFQUFFLEdBQUc7QUFDbkIscUJBQWUsRUFBRSxNQUFNLENBQUMsa0JBQWtCLEVBQUU7QUFDNUMsWUFBTSxFQUFOLE1BQU07S0FDUCxDQUFBO0FBQ0QsV0FBTyxRQUFRLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0dBQ3hDLENBQUE7O0FBRUQsWUFBVSxDQUFDLFlBQU07QUFDZixRQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUMvRCxRQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1Q0FBdUMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFBOztBQUUxRSxRQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FB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WUFBTSxDQUFDLFlBQVksRUFBRSxDQUFBO0FBQ3JCLFlBQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDdEIsWUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUN0QixZQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBOztBQUV0QixrQkFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUE7S0FDL0IsQ0FBQyxDQUFBO0FBQ0YsWUFBUSxDQUFDLDZCQUE2QixFQUFFLElBQUksRUFBRSxZQUFNO0FBQ2xELGFBQU8sVUFBVSxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0tBQ3RELENBQUMsQ0FBQTtBQUNGLFFBQUksQ0FBQyxZQUFNO0FBQ1QsVUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLDJCQUEyQixDQUFDLENBQUE7O0FBRS9ELFlBQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQTtLQUNqRSxDQUFDLENBQUE7R0FDSCxDQUFDLENBQUE7Q0FDSCxDQUFDLENBQUEiLCJmaWxlIjoiL2hvbWUvamdhcnJpc29uLy5hdG9tL3BhY2thZ2VzL2F1dG9jb21wbGV0ZS1wYXRocy9zcGVjL2F1dG9jb21wbGV0ZS1wYXRocy1zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcbi8qIGdsb2JhbCBhdG9tLCBleHBlY3QsIGRlc2NyaWJlLCBiZWZvcmVFYWNoLCBpdCwgd2FpdHNGb3JQcm9taXNlLCB3YWl0c0ZvciwgcnVucywgYWR2YW5jZUNsb2NrLCBqYXNtaW5lICovXG5cbmNvbnN0IENPTVBMRVRJT05fREVMQVkgPSAxMDBcblxuZGVzY3JpYmUoJ2F1dG9jb21wbGV0ZS1wYXRocycsICgpID0+IHtcbiAgbGV0IFsgZWRpdG9yLCBwcm92aWRlciBdID0gW11cbiAgY29uc3QgZ2V0U3VnZ2VzdGlvbnMgPSAoKSA9PiB7XG4gICAgY29uc3QgY3Vyc29yID0gZWRpdG9yLmdldExhc3RDdXJzb3IoKVxuICAgIGNvbnN0IHN0YXJ0ID0gY3Vyc29yLmdldEJlZ2lubmluZ09mQ3VycmVudFdvcmRCdWZmZXJQb3NpdGlvbigpXG4gICAgY29uc3QgZW5kID0gY3Vyc29yLmdldEJ1ZmZlclBvc2l0aW9uKClcbiAgICBjb25zdCBwcmVmaXggPSBlZGl0b3IuZ2V0VGV4dEluUmFuZ2UoW3N0YXJ0LCBlbmRdKVxuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICBlZGl0b3IsXG4gICAgICBidWZmZXJQb3NpdGlvbjogZW5kLFxuICAgICAgc2NvcGVEZXNjcmlwdG9yOiBjdXJzb3IuZ2V0U2NvcGVEZXNjcmlwdG9yKCksXG4gICAgICBwcmVmaXhcbiAgICB9XG4gICAgcmV0dXJuIHByb3ZpZGVyLmdldFN1Z2dlc3Rpb25zKHJlcXVlc3QpXG4gIH1cblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBhdG9tLmNvbmZpZy5zZXQoJ2F1dG9jb21wbGV0ZS1wbHVzLmVuYWJsZUF1dG9BY3RpdmF0aW9uJywgdHJ1ZSlcbiAgICBhdG9tLmNvbmZpZy5zZXQoJ2F1dG9jb21wbGV0ZS1wbHVzLmF1dG9BY3RpdmF0aW9uRGVsYXknLCBDT01QTEVUSU9OX0RFTEFZKVxuXG4gICAgbGV0IHdvcmtzcGFjZUVsZW1lbnQgPSBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpXG4gICAgamFzbWluZS5hdHRhY2hUb0RPTSh3b3Jrc3BhY2VFbGVtZW50KVxuXG4gICAgd2FpdHNGb3JQcm9taXNlKCgpID0+XG4gICAgICBQcm9taXNlLmFsbChbXG4gICAgICAgIGF0b20ud29ya3NwYWNlLm9wZW4oJ3NhbXBsZS5qcycpXG4gICAgICAgICAgLnRoZW4oKGUpID0+IHtcbiAgICAgICAgICAgIGVkaXRvciA9IGVcbiAgICAgICAgICB9KSxcbiAgICAgICAgYXRvbS5wYWNrYWdlcy5hY3RpdmF0ZVBhY2thZ2UoJ2xhbmd1YWdlLWphdmFzY3JpcHQnKSxcbiAgICAgICAgYXRvbS5wYWNrYWdlcy5hY3RpdmF0ZVBhY2thZ2UoJ2F1dG9jb21wbGV0ZS1wYXRocycpLFxuICAgICAgICBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZSgnYXV0b2NvbXBsZXRlLXBsdXMnKSxcbiAgICAgICAgYXRvbS5wYWNrYWdlcy5hY3RpdmF0ZVBhY2thZ2UoJ3N0YXR1cy1iYXInKVxuICAgICAgXSlcbiAgICApXG4gICAgcnVucygoKSA9PiB7XG4gICAgICBwcm92aWRlciA9IGF0b20ucGFja2FnZXMuZ2V0QWN0aXZlUGFja2FnZSgnYXV0b2NvbXBsZXRlLXBhdGhzJykubWFpbk1vZHVsZS5nZXRQcm92aWRlcigpXG4gICAgfSlcbiAgICB3YWl0c0ZvcigoKSA9PiBwcm92aWRlci5pc1JlYWR5KCkpXG4gIH0pXG5cbiAgaXQoJ3RyaWdnZXJzIHdoZW4gdGV4dCBiZWZvcmUgY3Vyc29yIG1hdGNoZXMgb25lIG9mIHRoZSBzY29wZXMnLCAoKSA9PiB7XG4gICAgcnVucygoKSA9PiB7XG4gICAgICBlZGl0b3Iuc2V0VGV4dCgncmVxdWlyZShcXCd0JylcbiAgICAgIGVkaXRvci5zZXRDdXJzb3JCdWZmZXJQb3NpdGlvbihbMCwgSW5maW5pdHldKVxuICAgIH0pXG4gICAgd2FpdHNGb3JQcm9taXNlKCgpID0+IGdldFN1Z2dlc3Rpb25zKClcbiAgICAgIC50aGVuKChzdWdnZXN0aW9ucykgPT4ge1xuICAgICAgICBleHBlY3Qoc3VnZ2VzdGlvbnMpLnRvSGF2ZUxlbmd0aCgyKVxuICAgICAgfSkpXG4gIH0pXG5cbiAgaXQoJ29ubHkgZGlzcGxheXMgZmlsZXMgcmVsZXZhbnQgdG8gdGhlIG1hdGNoaW5nIHNjb3BlJywgKCkgPT4ge1xuICAgIHdhaXRzRm9yUHJvbWlzZSgoKSA9PiBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZSgnbGFuZ3VhZ2UtamF2YXNjcmlwdCcpKVxuICAgIHJ1bnMoKCkgPT4ge1xuICAgICAgZWRpdG9yLnNldFRleHQoJ3JlcXVpcmUoXFwndCcpXG4gICAgICBlZGl0b3Iuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oWzAsIEluZmluaXR5XSlcbiAgICB9KVxuICAgIHdhaXRzRm9yUHJvbWlzZSgoKSA9PiBnZXRTdWdnZXN0aW9ucygpXG4gICAgICAudGhlbigoc3VnZ2VzdGlvbnMpID0+IHtcbiAgICAgICAgZXhwZWN0KHN1Z2dlc3Rpb25zKS50b0hhdmVMZW5ndGgoMilcbiAgICAgICAgZXhwZWN0KHN1Z2dlc3Rpb25zWzBdLmRpc3BsYXlUZXh0KS50b0JlKCdzb21lZGlyL3Rlc3RmaWxlLmpzJylcbiAgICAgICAgZXhwZWN0KHN1Z2dlc3Rpb25zWzFdLmRpc3BsYXlUZXh0KS50b0JlKCdzb21lZGlyL3Rlc3RkaXIvbmVzdGVkLXRlc3QtZmlsZS5qcycpXG4gICAgICB9KSlcbiAgfSlcblxuICBpdCgncmVtb3ZlcyB0aGUgZXh0ZW5zaW9uIHdoZW4gYWNjZXB0aW5nIGEgSlMgaW1wb3J0IHN1Z2dlc3Rpb24nLCAoKSA9PiB7XG4gICAgbGV0IGVkaXRvclZpZXdcbiAgICB3YWl0c0ZvclByb21pc2UoKCkgPT4gYXRvbS5wYWNrYWdlcy5hY3RpdmF0ZVBhY2thZ2UoJ2xhbmd1YWdlLWphdmFzY3JpcHQnKSlcbiAgICBydW5zKCgpID0+IHtcbiAgICAgIGVkaXRvclZpZXcgPSBhdG9tLnZpZXdzLmdldFZpZXcoZWRpdG9yKVxuICAgICAgZWRpdG9yLnNldFRleHQoJ3JlcXVpcmUoXFwnJylcbiAgICAgIGVkaXRvci5tb3ZlVG9Cb3R0b20oKVxuICAgICAgZWRpdG9yLmluc2VydFRleHQoJ3QnKVxuICAgICAgZWRpdG9yLmluc2VydFRleHQoJ2UnKVxuICAgICAgZWRpdG9yLmluc2VydFRleHQoJ3MnKVxuXG4gICAgICBhZHZhbmNlQ2xvY2soQ09NUExFVElPTl9ERUxBWSlcbiAgICB9KVxuICAgIHdhaXRzRm9yKCdhdXRvY29tcGxldGUgdmlldyB0byBhcHBlYXInLCAxMDAwLCAoKSA9PiB7XG4gICAgICByZXR1cm4gZWRpdG9yVmlldy5xdWVyeVNlbGVjdG9yKCcuYXV0b2NvbXBsZXRlLXBsdXMnKVxuICAgIH0pXG4gICAgcnVucygoKSA9PiB7XG4gICAgICBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKGVkaXRvclZpZXcsICdhdXRvY29tcGxldGUtcGx1czpjb25maXJtJylcblxuICAgICAgZXhwZWN0KGVkaXRvci5nZXRUZXh0KCkpLnRvRXF1YWwoJ3JlcXVpcmUoXFwnLi9zb21lZGlyL3Rlc3RmaWxlJylcbiAgICB9KVxuICB9KVxufSlcbiJdfQ==