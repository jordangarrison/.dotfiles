function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/** @babel */

var _specHelpers = require('./spec-helpers');

var _specHelpers2 = _interopRequireDefault(_specHelpers);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _libBuilder = require('../lib/builder');

var _libBuilder2 = _interopRequireDefault(_libBuilder);

var _libBuildState = require('../lib/build-state');

var _libBuildState2 = _interopRequireDefault(_libBuildState);

describe('Builder', function () {
  var builder = undefined,
      fixturesPath = undefined,
      filePath = undefined,
      logFilePath = undefined,
      fdbFilePath = undefined,
      state = undefined,
      jobState = undefined;

  beforeEach(function () {
    builder = new _libBuilder2['default']();
    fixturesPath = _specHelpers2['default'].cloneFixtures();
    filePath = _path2['default'].join(fixturesPath, 'file.tex');
    logFilePath = _path2['default'].join(fixturesPath, 'file.log');
    fdbFilePath = _path2['default'].join(fixturesPath, 'file.fdb_latexmk');
    state = new _libBuildState2['default'](filePath);
    state.setOutputDirectory('');
    jobState = state.getJobStates()[0];
  });

  describe('constructPath', function () {
    it('reads `latex.texPath` as configured', function () {
      spyOn(atom.config, 'get').andReturn();
      builder.constructPath();

      expect(atom.config.get).toHaveBeenCalledWith('latex.texPath');
    });

    it('uses platform default when `latex.texPath` is not configured', function () {
      var defaultTexPath = '/foo/bar';
      var expectedPath = [defaultTexPath, process.env.PATH].join(_path2['default'].delimiter);
      atom.config.set('latex.texPath', '');
      spyOn(builder, 'defaultTexPath').andReturn(defaultTexPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('replaces surrounded $PATH with process.env.PATH', function () {
      var texPath = '/foo:$PATH:/bar';
      var expectedPath = texPath.replace('$PATH', process.env.PATH);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('replaces leading $PATH with process.env.PATH', function () {
      var texPath = '$PATH:/bar';
      var expectedPath = texPath.replace('$PATH', process.env.PATH);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('replaces trailing $PATH with process.env.PATH', function () {
      var texPath = '/foo:$PATH';
      var expectedPath = texPath.replace('$PATH', process.env.PATH);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('prepends process.env.PATH with texPath', function () {
      var texPath = '/foo';
      var expectedPath = [texPath, process.env.PATH].join(_path2['default'].delimiter);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });
  });

  describe('parseLogFile', function () {
    var logParser = undefined;

    beforeEach(function () {
      logParser = jasmine.createSpyObj('MockLogParser', ['parse']);
      spyOn(builder, 'getLogParser').andReturn(logParser);
    });

    it('resolves the associated log file path by invoking @resolveLogFilePath', function () {
      spyOn(builder, 'resolveLogFilePath').andReturn('foo.log');

      builder.parseLogFile(jobState);
      expect(builder.resolveLogFilePath).toHaveBeenCalledWith(jobState);
    });

    it('does not attempt parse if passed a file path that does not exist', function () {
      state.setFilePath('/foo/bar/quux.tex');
      builder.parseLogFile(jobState);

      expect(logParser.parse).not.toHaveBeenCalled();
    });

    it('attempts to parse the resolved log file', function () {
      builder.parseLogFile(jobState);

      expect(builder.getLogParser).toHaveBeenCalledWith(logFilePath, filePath);
      expect(logParser.parse).toHaveBeenCalled();
    });
  });

  describe('parseFdbFile', function () {
    var fdbParser = undefined;

    beforeEach(function () {
      fdbParser = jasmine.createSpyObj('MockFdbParser', ['parse']);
      spyOn(builder, 'getFdbParser').andReturn(fdbParser);
    });

    it('resolves the associated fdb file path by invoking @resolveFdbFilePath', function () {
      spyOn(builder, 'resolveFdbFilePath').andReturn('foo.fdb_latexmk');

      builder.parseFdbFile(jobState);
      expect(builder.resolveFdbFilePath).toHaveBeenCalledWith(jobState);
    });

    it('does not attempt parse if passed a file path that does not exist', function () {
      state.setFilePath('/foo/bar/quux.tex');
      builder.parseFdbFile(jobState);

      expect(fdbParser.parse).not.toHaveBeenCalled();
    });

    it('attempts to parse the resolved fdb file', function () {
      builder.parseFdbFile(jobState);

      expect(builder.getFdbParser).toHaveBeenCalledWith(fdbFilePath);
      expect(fdbParser.parse).toHaveBeenCalled();
    });
  });

  describe('parseLogAndFdbFiles', function () {
    it('verifies that the correct output file is selected when using various latexmk modes', function () {
      var switches = [{
        name: 'pdf',
        format: 'pdf'
      }, {
        name: 'pdfdvi',
        format: 'pdf'
      }, {
        name: 'pdfps',
        format: 'pdf'
      }, {
        name: 'ps',
        format: 'ps'
      }, {
        name: 'dvi',
        format: 'dvi'
      }];
      state.setOutputDirectory('log-parse');

      for (var _ref2 of switches) {
        var _name = _ref2.name;
        var format = _ref2.format;

        state.setJobNames(['file-' + _name]);
        jobState = state.getJobStates()[0];
        builder.parseLogAndFdbFiles(jobState);
        expect(_path2['default'].basename(jobState.getOutputFilePath())).toBe(jobState.getJobName() + '.' + format, 'Select ' + format + ' file when using -' + _name + ' switch.');
      }
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2pnYXJyaXNvbi8uYXRvbS9wYWNrYWdlcy9sYXRleC9zcGVjL2J1aWxkZXItc3BlYy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OzJCQUVvQixnQkFBZ0I7Ozs7b0JBQ25CLE1BQU07Ozs7MEJBQ0gsZ0JBQWdCOzs7OzZCQUNiLG9CQUFvQjs7OztBQUUzQyxRQUFRLENBQUMsU0FBUyxFQUFFLFlBQU07QUFDeEIsTUFBSSxPQUFPLFlBQUE7TUFBRSxZQUFZLFlBQUE7TUFBRSxRQUFRLFlBQUE7TUFBRSxXQUFXLFlBQUE7TUFBRSxXQUFXLFlBQUE7TUFBRSxLQUFLLFlBQUE7TUFBRSxRQUFRLFlBQUEsQ0FBQTs7QUFFOUUsWUFBVSxDQUFDLFlBQU07QUFDZixXQUFPLEdBQUcsNkJBQWEsQ0FBQTtBQUN2QixnQkFBWSxHQUFHLHlCQUFRLGFBQWEsRUFBRSxDQUFBO0FBQ3RDLFlBQVEsR0FBRyxrQkFBSyxJQUFJLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQzlDLGVBQVcsR0FBRyxrQkFBSyxJQUFJLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQ2pELGVBQVcsR0FBRyxrQkFBSyxJQUFJLENBQUMsWUFBWSxFQUFFLGtCQUFrQixDQUFDLENBQUE7QUFDekQsU0FBSyxHQUFHLCtCQUFlLFFBQVEsQ0FBQyxDQUFBO0FBQ2hDLFNBQUssQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQTtBQUM1QixZQUFRLEdBQUcsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0dBQ25DLENBQUMsQ0FBQTs7QUFFRixVQUFRLENBQUMsZUFBZSxFQUFFLFlBQU07QUFDOUIsTUFBRSxDQUFDLHFDQUFxQyxFQUFFLFlBQU07QUFDOUMsV0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUE7QUFDckMsYUFBTyxDQUFDLGFBQWEsRUFBRSxDQUFBOztBQUV2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L3NwZWMvYnVpbGRlci1zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIEBiYWJlbCAqL1xuXG5pbXBvcnQgaGVscGVycyBmcm9tICcuL3NwZWMtaGVscGVycydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgQnVpbGRlciBmcm9tICcuLi9saWIvYnVpbGRlcidcbmltcG9ydCBCdWlsZFN0YXRlIGZyb20gJy4uL2xpYi9idWlsZC1zdGF0ZSdcblxuZGVzY3JpYmUoJ0J1aWxkZXInLCAoKSA9PiB7XG4gIGxldCBidWlsZGVyLCBmaXh0dXJlc1BhdGgsIGZpbGVQYXRoLCBsb2dGaWxlUGF0aCwgZmRiRmlsZVBhdGgsIHN0YXRlLCBqb2JTdGF0ZVxuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcigpXG4gICAgZml4dHVyZXNQYXRoID0gaGVscGVycy5jbG9uZUZpeHR1cmVzKClcbiAgICBmaWxlUGF0aCA9IHBhdGguam9pbihmaXh0dXJlc1BhdGgsICdmaWxlLnRleCcpXG4gICAgbG9nRmlsZVBhdGggPSBwYXRoLmpvaW4oZml4dHVyZXNQYXRoLCAnZmlsZS5sb2cnKVxuICAgIGZkYkZpbGVQYXRoID0gcGF0aC5qb2luKGZpeHR1cmVzUGF0aCwgJ2ZpbGUuZmRiX2xhdGV4bWsnKVxuICAgIHN0YXRlID0gbmV3IEJ1aWxkU3RhdGUoZmlsZVBhdGgpXG4gICAgc3RhdGUuc2V0T3V0cHV0RGlyZWN0b3J5KCcnKVxuICAgIGpvYlN0YXRlID0gc3RhdGUuZ2V0Sm9iU3RhdGVzKClbMF1cbiAgfSlcblxuICBkZXNjcmliZSgnY29uc3RydWN0UGF0aCcsICgpID0+IHtcbiAgICBpdCgncmVhZHMgYGxhdGV4LnRleFBhdGhgIGFzIGNvbmZpZ3VyZWQnLCAoKSA9PiB7XG4gICAgICBzcHlPbihhdG9tLmNvbmZpZywgJ2dldCcpLmFuZFJldHVybigpXG4gICAgICBidWlsZGVyLmNvbnN0cnVjdFBhdGgoKVxuXG4gICAgICBleHBlY3QoYXRvbS5jb25maWcuZ2V0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnbGF0ZXgudGV4UGF0aCcpXG4gICAgfSlcblxuICAgIGl0KCd1c2VzIHBsYXRmb3JtIGRlZmF1bHQgd2hlbiBgbGF0ZXgudGV4UGF0aGAgaXMgbm90IGNvbmZpZ3VyZWQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBkZWZhdWx0VGV4UGF0aCA9ICcvZm9vL2JhcidcbiAgICAgIGNvbnN0IGV4cGVjdGVkUGF0aCA9IFtkZWZhdWx0VGV4UGF0aCwgcHJvY2Vzcy5lbnYuUEFUSF0uam9pbihwYXRoLmRlbGltaXRlcilcbiAgICAgIGF0b20uY29uZmlnLnNldCgnbGF0ZXgudGV4UGF0aCcsICcnKVxuICAgICAgc3B5T24oYnVpbGRlciwgJ2RlZmF1bHRUZXhQYXRoJykuYW5kUmV0dXJuKGRlZmF1bHRUZXhQYXRoKVxuXG4gICAgICBjb25zdCBjb25zdHJ1Y3RlZFBhdGggPSBidWlsZGVyLmNvbnN0cnVjdFBhdGgoKVxuICAgICAgZXhwZWN0KGNvbnN0cnVjdGVkUGF0aCkudG9CZShleHBlY3RlZFBhdGgpXG4gICAgfSlcblxuICAgIGl0KCdyZXBsYWNlcyBzdXJyb3VuZGVkICRQQVRIIHdpdGggcHJvY2Vzcy5lbnYuUEFUSCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHRleFBhdGggPSAnL2ZvbzokUEFUSDovYmFyJ1xuICAgICAgY29uc3QgZXhwZWN0ZWRQYXRoID0gdGV4UGF0aC5yZXBsYWNlKCckUEFUSCcsIHByb2Nlc3MuZW52LlBBVEgpXG4gICAgICBhdG9tLmNvbmZpZy5zZXQoJ2xhdGV4LnRleFBhdGgnLCB0ZXhQYXRoKVxuXG4gICAgICBjb25zdCBjb25zdHJ1Y3RlZFBhdGggPSBidWlsZGVyLmNvbnN0cnVjdFBhdGgoKVxuICAgICAgZXhwZWN0KGNvbnN0cnVjdGVkUGF0aCkudG9CZShleHBlY3RlZFBhdGgpXG4gICAgfSlcblxuICAgIGl0KCdyZXBsYWNlcyBsZWFkaW5nICRQQVRIIHdpdGggcHJvY2Vzcy5lbnYuUEFUSCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHRleFBhdGggPSAnJFBBVEg6L2JhcidcbiAgICAgIGNvbnN0IGV4cGVjdGVkUGF0aCA9IHRleFBhdGgucmVwbGFjZSgnJFBBVEgnLCBwcm9jZXNzLmVudi5QQVRIKVxuICAgICAgYXRvbS5jb25maWcuc2V0KCdsYXRleC50ZXhQYXRoJywgdGV4UGF0aClcblxuICAgICAgY29uc3QgY29uc3RydWN0ZWRQYXRoID0gYnVpbGRlci5jb25zdHJ1Y3RQYXRoKClcbiAgICAgIGV4cGVjdChjb25zdHJ1Y3RlZFBhdGgpLnRvQmUoZXhwZWN0ZWRQYXRoKVxuICAgIH0pXG5cbiAgICBpdCgncmVwbGFjZXMgdHJhaWxpbmcgJFBBVEggd2l0aCBwcm9jZXNzLmVudi5QQVRIJywgKCkgPT4ge1xuICAgICAgY29uc3QgdGV4UGF0aCA9ICcvZm9vOiRQQVRIJ1xuICAgICAgY29uc3QgZXhwZWN0ZWRQYXRoID0gdGV4UGF0aC5yZXBsYWNlKCckUEFUSCcsIHByb2Nlc3MuZW52LlBBVEgpXG4gICAgICBhdG9tLmNvbmZpZy5zZXQoJ2xhdGV4LnRleFBhdGgnLCB0ZXhQYXRoKVxuXG4gICAgICBjb25zdCBjb25zdHJ1Y3RlZFBhdGggPSBidWlsZGVyLmNvbnN0cnVjdFBhdGgoKVxuICAgICAgZXhwZWN0KGNvbnN0cnVjdGVkUGF0aCkudG9CZShleHBlY3RlZFBhdGgpXG4gICAgfSlcblxuICAgIGl0KCdwcmVwZW5kcyBwcm9jZXNzLmVudi5QQVRIIHdpdGggdGV4UGF0aCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHRleFBhdGggPSAnL2ZvbydcbiAgICAgIGNvbnN0IGV4cGVjdGVkUGF0aCA9IFt0ZXhQYXRoLCBwcm9jZXNzLmVudi5QQVRIXS5qb2luKHBhdGguZGVsaW1pdGVyKVxuICAgICAgYXRvbS5jb25maWcuc2V0KCdsYXRleC50ZXhQYXRoJywgdGV4UGF0aClcblxuICAgICAgY29uc3QgY29uc3RydWN0ZWRQYXRoID0gYnVpbGRlci5jb25zdHJ1Y3RQYXRoKClcbiAgICAgIGV4cGVjdChjb25zdHJ1Y3RlZFBhdGgpLnRvQmUoZXhwZWN0ZWRQYXRoKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3BhcnNlTG9nRmlsZScsICgpID0+IHtcbiAgICBsZXQgbG9nUGFyc2VyXG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGxvZ1BhcnNlciA9IGphc21pbmUuY3JlYXRlU3B5T2JqKCdNb2NrTG9nUGFyc2VyJywgWydwYXJzZSddKVxuICAgICAgc3B5T24oYnVpbGRlciwgJ2dldExvZ1BhcnNlcicpLmFuZFJldHVybihsb2dQYXJzZXIpXG4gICAgfSlcblxuICAgIGl0KCdyZXNvbHZlcyB0aGUgYXNzb2NpYXRlZCBsb2cgZmlsZSBwYXRoIGJ5IGludm9raW5nIEByZXNvbHZlTG9nRmlsZVBhdGgnLCAoKSA9PiB7XG4gICAgICBzcHlPbihidWlsZGVyLCAncmVzb2x2ZUxvZ0ZpbGVQYXRoJykuYW5kUmV0dXJuKCdmb28ubG9nJylcblxuICAgICAgYnVpbGRlci5wYXJzZUxvZ0ZpbGUoam9iU3RhdGUpXG4gICAgICBleHBlY3QoYnVpbGRlci5yZXNvbHZlTG9nRmlsZVBhdGgpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGpvYlN0YXRlKVxuICAgIH0pXG5cbiAgICBpdCgnZG9lcyBub3QgYXR0ZW1wdCBwYXJzZSBpZiBwYXNzZWQgYSBmaWxlIHBhdGggdGhhdCBkb2VzIG5vdCBleGlzdCcsICgpID0+IHtcbiAgICAgIHN0YXRlLnNldEZpbGVQYXRoKCcvZm9vL2Jhci9xdXV4LnRleCcpXG4gICAgICBidWlsZGVyLnBhcnNlTG9nRmlsZShqb2JTdGF0ZSlcblxuICAgICAgZXhwZWN0KGxvZ1BhcnNlci5wYXJzZSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgIH0pXG5cbiAgICBpdCgnYXR0ZW1wdHMgdG8gcGFyc2UgdGhlIHJlc29sdmVkIGxvZyBmaWxlJywgKCkgPT4ge1xuICAgICAgYnVpbGRlci5wYXJzZUxvZ0ZpbGUoam9iU3RhdGUpXG5cbiAgICAgIGV4cGVjdChidWlsZGVyLmdldExvZ1BhcnNlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgobG9nRmlsZVBhdGgsIGZpbGVQYXRoKVxuICAgICAgZXhwZWN0KGxvZ1BhcnNlci5wYXJzZSkudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgncGFyc2VGZGJGaWxlJywgKCkgPT4ge1xuICAgIGxldCBmZGJQYXJzZXJcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgZmRiUGFyc2VyID0gamFzbWluZS5jcmVhdGVTcHlPYmooJ01vY2tGZGJQYXJzZXInLCBbJ3BhcnNlJ10pXG4gICAgICBzcHlPbihidWlsZGVyLCAnZ2V0RmRiUGFyc2VyJykuYW5kUmV0dXJuKGZkYlBhcnNlcilcbiAgICB9KVxuXG4gICAgaXQoJ3Jlc29sdmVzIHRoZSBhc3NvY2lhdGVkIGZkYiBmaWxlIHBhdGggYnkgaW52b2tpbmcgQHJlc29sdmVGZGJGaWxlUGF0aCcsICgpID0+IHtcbiAgICAgIHNweU9uKGJ1aWxkZXIsICdyZXNvbHZlRmRiRmlsZVBhdGgnKS5hbmRSZXR1cm4oJ2Zvby5mZGJfbGF0ZXhtaycpXG5cbiAgICAgIGJ1aWxkZXIucGFyc2VGZGJGaWxlKGpvYlN0YXRlKVxuICAgICAgZXhwZWN0KGJ1aWxkZXIucmVzb2x2ZUZkYkZpbGVQYXRoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChqb2JTdGF0ZSlcbiAgICB9KVxuXG4gICAgaXQoJ2RvZXMgbm90IGF0dGVtcHQgcGFyc2UgaWYgcGFzc2VkIGEgZmlsZSBwYXRoIHRoYXQgZG9lcyBub3QgZXhpc3QnLCAoKSA9PiB7XG4gICAgICBzdGF0ZS5zZXRGaWxlUGF0aCgnL2Zvby9iYXIvcXV1eC50ZXgnKVxuICAgICAgYnVpbGRlci5wYXJzZUZkYkZpbGUoam9iU3RhdGUpXG5cbiAgICAgIGV4cGVjdChmZGJQYXJzZXIucGFyc2UpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICB9KVxuXG4gICAgaXQoJ2F0dGVtcHRzIHRvIHBhcnNlIHRoZSByZXNvbHZlZCBmZGIgZmlsZScsICgpID0+IHtcbiAgICAgIGJ1aWxkZXIucGFyc2VGZGJGaWxlKGpvYlN0YXRlKVxuXG4gICAgICBleHBlY3QoYnVpbGRlci5nZXRGZGJQYXJzZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGZkYkZpbGVQYXRoKVxuICAgICAgZXhwZWN0KGZkYlBhcnNlci5wYXJzZSkudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgncGFyc2VMb2dBbmRGZGJGaWxlcycsICgpID0+IHtcbiAgICBpdCgndmVyaWZpZXMgdGhhdCB0aGUgY29ycmVjdCBvdXRwdXQgZmlsZSBpcyBzZWxlY3RlZCB3aGVuIHVzaW5nIHZhcmlvdXMgbGF0ZXhtayBtb2RlcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHN3aXRjaGVzID0gW3tcbiAgICAgICAgbmFtZTogJ3BkZicsXG4gICAgICAgIGZvcm1hdDogJ3BkZidcbiAgICAgIH0sIHtcbiAgICAgICAgbmFtZTogJ3BkZmR2aScsXG4gICAgICAgIGZvcm1hdDogJ3BkZidcbiAgICAgIH0sIHtcbiAgICAgICAgbmFtZTogJ3BkZnBzJyxcbiAgICAgICAgZm9ybWF0OiAncGRmJ1xuICAgICAgfSwge1xuICAgICAgICBuYW1lOiAncHMnLFxuICAgICAgICBmb3JtYXQ6ICdwcydcbiAgICAgIH0sIHtcbiAgICAgICAgbmFtZTogJ2R2aScsXG4gICAgICAgIGZvcm1hdDogJ2R2aSdcbiAgICAgIH1dXG4gICAgICBzdGF0ZS5zZXRPdXRwdXREaXJlY3RvcnkoJ2xvZy1wYXJzZScpXG5cbiAgICAgIGZvciAoY29uc3QgeyBuYW1lLCBmb3JtYXQgfSBvZiBzd2l0Y2hlcykge1xuICAgICAgICBzdGF0ZS5zZXRKb2JOYW1lcyhbYGZpbGUtJHtuYW1lfWBdKVxuICAgICAgICBqb2JTdGF0ZSA9IHN0YXRlLmdldEpvYlN0YXRlcygpWzBdXG4gICAgICAgIGJ1aWxkZXIucGFyc2VMb2dBbmRGZGJGaWxlcyhqb2JTdGF0ZSlcbiAgICAgICAgZXhwZWN0KHBhdGguYmFzZW5hbWUoam9iU3RhdGUuZ2V0T3V0cHV0RmlsZVBhdGgoKSkpLnRvQmUoYCR7am9iU3RhdGUuZ2V0Sm9iTmFtZSgpfS4ke2Zvcm1hdH1gLFxuICAgICAgICAgIGBTZWxlY3QgJHtmb3JtYXR9IGZpbGUgd2hlbiB1c2luZyAtJHtuYW1lfSBzd2l0Y2guYClcbiAgICAgIH1cbiAgICB9KVxuICB9KVxufSlcbiJdfQ==